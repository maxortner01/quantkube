# DO NOT CHANGE
# THIS FILE IS AUTOGENERATED
# See deploy.py

FROM base-env AS external_deps

# Get flatbuffers
RUN wget https://github.com/google/flatbuffers/archive/refs/tags/v25.2.10.tar.gz --no-check-certificate && tar -xvzf v25.2.10.tar.gz

# Compile flatbuffers
RUN cd flatbuffers-25.2.10 && cmake -DFLATBUFFERS_BUILD_SHAREDLIB=ON . && make -j
RUN mkdir external \ 
    && mkdir external/flatbuffers \
    && cp flatbuffers-25.2.10/flatc external/flatbuffers/flatc \
    && cp flatbuffers-25.2.10/libflatbuffers.so external/flatbuffers/libflatbuffers.so \
    && cp -r flatbuffers-25.2.10/include external/flatbuffers/include

# Copy over asio
RUN wget https://sourceforge.net/projects/asio/files/asio/1.30.2%20%28Stable%29/asio-1.30.2.tar.gz --no-check-certificate && tar -xvzf asio-1.30.2.tar.gz
RUN mkdir external/asio \
    && cp -r ./asio-1.30.2/include ./external/asio/include

# Generate schemas
FROM base-env AS schemas

COPY --from=external_deps /external/flatbuffers /external/flatbuffers

COPY ./api ./api
RUN ./external/flatbuffers/flatc --cpp -o ./schemas ./api/*.fbs 

# Compile and run the service
FROM base-env

COPY --from=external_deps /external /external
COPY --from=schemas       /schemas  /schemas
COPY {{ service_dir  }} .

RUN cmake . && make -j

ENTRYPOINT ["./{{ name }}"]